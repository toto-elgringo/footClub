{% extends 'layouts/base.twig' %}

{% block title %}Matchs - Foot Club{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="../css/matchs.css">
{% endblock %}

{% block content %}
    <div class="header">
        <div class="page-title">
            <div>
                <h1>Matchs</h1>
                <p>Gerez les matchs de votre club</p>
            </div>
            <div>
                <button class="submit-button"> + Ajouter un match </button>
            </div>
        </div>

        {% include 'components/errors.twig' with {'validator': validator} %}

        <div class="header-toggle-add">

            <h3>Ajouter un nouveau club adverse</h3>
            <form action="matchs.php" method="post" class="form-grid">
                <div class="form-group">
                    <label for="new_club_city">Ville du club</label>
                    <input type="text" name="new_club_city" id="new_club_city" required>
                </div>

                <div class="form-group">
                    <label for="new_club_address">Adresse</label>
                    <input type="text" name="new_club_address" id="new_club_address" required>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Ajouter le club</button>
                </div>
            </form>

            <h3>Ajouter un match</h3>
            <form action="matchs.php" method="post" class="form-grid">
                <div class="form-group">
                    <label for="team_id">√âquipe</label>
                    <select name="team_id" id="team_id" required>
                        <option>S√©lectionner une √©quipe</option>
                        {% if teams is not empty %}
                            {% for team in teams %}
                                <option value="{{ team.getId() }}">{{ team.getName() }}</option>
                            {% endfor %}
                        {% else %}
                            <option disabled>Aucune √©quipe disponible</option>
                        {% endif %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="opposing_club_id">Club adverse</label>
                    <select name="opposing_club_id" id="opposing_club_id" required>
                        <option>S√©lectionner un club</option>
                        {% for club in opposing_clubs %}
                            <option value="{{ club.getId() }}">{{ club.getCity() }} - {{ club.getName() }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="match_date">Date du match</label>
                    <input type="datetime-local" name="match_date" id="match_date" required>
                </div>

                <div class="form-group">
                    <label for="city">Lieu du match</label>
                    <input type="text" name="city" id="city" required>
                </div>

                <div class="form-group">
                    <label for="team_score">Score de l'√©quipe</label>
                    <input type="number" name="team_score" id="team_score" min="0" max="20" value="0">
                </div>

                <div class="form-group">
                    <label for="opponent_score">Score de l'adversaire</label>
                    <input type="number" name="opponent_score" id="opponent_score" min="0" max="20" value="0">
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Enregistrer le match</button>
                </div>
            </form>
        </div>
    </div>

    <div class="dashboard">
        <h2>Liste des matchs</h2>

        <div class="match-card-container">
            {% if matchs is empty %}
                <p>Aucun match programm√© pour le moment.</p>
            {% else %}
                {% for match in matchs %}
                    {% set match_date = match.getDate() %}
                    {% set is_past = match_date < now %}
                    {% set is_win = match.getTeamScore() > match.getOpponentScore() %}
                    {% set is_draw = match.getTeamScore() == match.getOpponentScore() %}
                    {% set opposingClub = opposingClubManager.findById(match.getOpposingClubId()) %}
                    {% set opponent_name = opposingClub ? opposingClub.getCity() : 'Club inconnu' %}

                    <div class="match-card card {% if is_past %}{% if is_win %}win{% elseif is_draw %}draw{% else %}lose{% endif %}{% endif %}"
                         data-type="match" data-id="{{ match.getId() }}">
                        <span class="delete">‚úï</span>
                        <form method="post" action="matchs.php" class="delete-player-form delete-form" style="display:none;">
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="id" value="{{ match.getId() }}">
                        </form>

                        <a href="matchsUpdate.php?id={{ match.getId() }}" class="match-card-link">
                            <div class="match-date">
                                {{ match_date.format('d/m/Y') }}
                            </div>
                        </a>

                        <div class="match-content">
                            <div class="match-teams">
                                {# √âquipe √† domicile #}
                                <div class="team-row">
                                    <div class="team">
                                        {% set teamId = match.getTeamId() %}
                                        {% set teamName = '√âquipe inconnue' %}
                                        {% if teamId is not null %}
                                            {% set team = teamManager.findById(teamId) %}
                                            {% if team %}
                                                {% set teamName = team.getName() %}
                                            {% endif %}
                                        {% endif %}
                                        <span class="team-name">{{ teamName }}</span>
                                    </div>
                                    {% if is_past %}
                                        <span class="score">{{ match.getTeamScore() }}</span>
                                    {% else %}
                                        <span class="score">-</span>
                                    {% endif %}
                                </div>

                                <div class="match-separator">
                                    <span>VS</span>
                                </div>

                                {# √âquipe adverse #}
                                <div class="team-row">
                                    <div class="team">
                                        <span class="team-name">{{ opponent_name }}</span>
                                    </div>
                                    {% if is_past %}
                                        <span class="score">{{ match.getOpponentScore() }}</span>
                                    {% else %}
                                        <span class="score">-</span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="status-line"></div>
                        </div>

                        <div class="match-footer">
                            <div class="match-location">
                                <span>üìç</span>
                                <span>{{ match.getCity() }}</span>
                            </div>
                            <div class="match-status">
                                {% if is_past %}
                                    {% if is_draw %}
                                        Match nul
                                    {% else %}
                                        {{ is_win ? 'Victoire' : 'D√©faite' }}
                                    {% endif %}
                                {% else %}
                                    √Ä venir
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
{% endblock %}
